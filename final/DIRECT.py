import math as math
from scipy import optimize as op
from sim import signal_sim

# 0 == empty
# 1 == wall
# 3 == receiver
m1 =[
    [3, 3, 3, 1, 3, 3, 1, 3, 3, 3],
    [3, 0, 0, 0, 0, 0, 0, 0, 0, 3],
    [3, 0, 0, 1, 0, 0, 1, 0, 0, 3],
    [3, 0, 0, 1, 0, 0, 1, 0, 0, 3],
    [1, 1, 1, 1, 0, 0, 1, 1, 1, 1],
    [3, 0, 0, 0, 0, 0, 0, 0, 0, 3],
    [3, 0, 0, 0, 0, 0, 0, 0, 0, 3],
    [1, 0, 1, 1, 0, 0, 1, 1, 1, 1],
    [3, 0, 0, 1, 0, 0, 0, 0, 0, 3],
    [3, 3, 3, 1, 3, 3, 1, 3, 3, 3]
]

m2 =[
    [0, 0, 0, 1, 0, 0, 1, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 3, 0],
    [0, 3, 0, 1, 0, 0, 1, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 1, 0, 0, 0],
    [1, 1, 1, 1, 0, 0, 1, 1, 1, 1],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [1, 0, 1, 1, 0, 0, 1, 1, 1, 1],
    [0, 0, 3, 1, 0, 0, 0, 0, 3, 0],
    [0, 0, 0, 1, 0, 0, 1, 0, 0, 0]
]

m2_2 =[
    [3, 0, 3, 1, 3, 0, 1, 3, 0, 3],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 3, 0, 1, 3, 0, 1, 0, 3, 0],
    [0, 0, 0, 1, 0, 0, 1, 0, 0, 0],
    [1, 1, 1, 1, 0, 0, 1, 1, 1, 1],
    [3, 0, 3, 0, 3, 0, 3, 0, 3, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [1, 0, 1, 1, 0, 0, 1, 1, 1, 1],
    [0, 3, 0, 1, 3, 0, 3, 0, 3, 0],
    [0, 0, 0, 1, 0, 0, 1, 0, 0, 0]
]

m3 = [
    [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,],
    [3,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,3,],
    [3,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,3,],
    [3,1,0,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,3,],
    [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,],
    [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,],
    [3,0,0,1,1,1,0,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,3,],
    [3,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,3,],
    [3,0,0,1,0,0,0,1,1,1,1,1,0,0,1,0,0,0,0,0,0,0,0,3,],
    [3,0,0,1,0,0,0,0,0,0,0,1,0,0,1,1,0,1,1,1,1,0,1,3,],
    [3,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,3,],
    [3,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,3,],
    [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,]
]

m4 = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,],
    [1,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,],
    [1,3,0,1,0,3,0,1,0,3,0,1,0,3,0,1,0,3,0,1,0,3,0,1,],
    [1,1,0,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,],
    [1,0,0,1,1,1,0,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,],
    [1,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,3,0,0,0,1,],
    [1,0,0,1,0,0,0,1,1,1,1,1,0,0,1,0,0,0,0,0,0,0,0,1,],
    [1,0,0,1,0,0,0,0,0,0,0,1,0,0,1,1,0,1,1,1,1,0,1,1,],
    [1,0,0,1,0,0,0,3,0,0,0,1,0,0,1,0,3,0,1,0,0,3,0,1,],
    [1,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,1,],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,],
]

m5 = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,],
    [1,3,0,1,3,0,3,1,3,0,3,1,3,0,3,1,3,0,3,1,3,0,3,1,],
    [1,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,],
    [1,1,3,1,1,3,1,1,1,3,1,1,1,3,1,1,1,3,1,1,1,3,1,1,],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,],
    [1,3,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0,1,],
    [1,0,0,1,1,1,0,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,],
    [1,0,3,1,3,0,3,0,3,0,3,1,3,0,1,0,3,0,3,0,3,0,3,1,],
    [1,0,0,1,0,0,0,1,1,1,1,1,0,0,1,0,0,0,0,0,0,0,0,1,],
    [1,3,0,1,3,0,3,0,3,0,3,1,3,0,1,1,3,1,1,1,1,3,1,1,],
    [1,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,1,],
    [1,0,3,1,0,3,0,3,0,3,0,1,0,3,1,3,0,3,1,3,0,3,0,1,],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,],
]

map1 = [
    "1111111111111111111111111111111111111111",
    "1000001000000010000000000100010000000001",
    "1000001000000000000000000100000000000001",
    "1000001000000010000000000100010000000001",
    "1101111111111011111111111100011111111111",
    "1000000000000000000000000000000000000001",
    "1000000000000000000000000000000000000001",
    "1000000000000000000000000000000000000001",
    "1000110111011101110111011101110111011001",
    "1000100010001000100010001000100010001001",
    "1000100010001000100010001000100010001001",
    "1000111111111111111111111111111111111001",
    "1000100010001000100010001000100010001001",
    "1000100010001000100010001000100010001001",
    "1000110111011101110111011101110111011001",
    "1000000000000000000000000000000000000001",
    "1000000000000000000000000000000000000001",
    "1000000000000000000000000000000000000001",
    "1111111111111111111111111111111111111111",
]
#21
map2 = [
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "11111111111111111111111111110000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000011111111111111111111111111111111111111111111111111111111111",
    "00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000",
    "00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000",
    "11111111111111111111111111110000011111111111111111111111111111111111111111111111111111111111",
    "00000000000000000000000000010000010000000000000000000000000000000000000000000000000000000000"
]


TERMINATE_FLOAT = 0.00001
TRANSMIT_POWER = 100
ROOM_MAP = map2
IS_EMPTY = True

FIRST_COORD = None
POINTS = []



#get reciever coords
R_COORD_LIST = []
scatterMap = [[]]
paremMap = []
if IS_EMPTY:
    #scattered receivers
    temp_stack = [3]
    for x in range(0, len(ROOM_MAP)):
        scatterMap.append([])
        for y_val in ROOM_MAP[x]:
            if temp_stack.pop() == 3:
                if y_val != '1':
                    scatterMap[x].append(3)
                else:
                    scatterMap[x].append(int(y_val))
                temp_stack.append(3)
                temp_stack.append(1)
                temp_stack.append(1)
            else:
                scatterMap[x].append(int(y_val))
    
    #receivers around border
    paremMap.append([])
    for x in range(0, len(ROOM_MAP[0])):
        paremMap[0].append(3)

    for x in range(1, len(ROOM_MAP)-1):
        paremMap.append([3])
        for y in range(1, len(ROOM_MAP[x])-1):
            paremMap[x].append(int(ROOM_MAP[x][y]))
        paremMap[x].append(3)

    paremMap.append([])
    for x in range(0, len(ROOM_MAP[0])):
        paremMap[len(paremMap)-1].append(3)
        

def getReceivers():
    global R_COORD_LIST
    for i in range( len(ROOM_MAP) ):
        for j in range( len(ROOM_MAP[i]) ):
            if ROOM_MAP[i][j] == 3:
                R_COORD_LIST.append( (i, j) )

def toMapArray():
    newArray = []
    for row in ROOM_MAP:
        newArray.append([])
        for cell in row:
            newArray[len(newArray)-1].append(int(cell))
    return newArray

def printMap():
    for row in ROOM_MAP:
        printLine = ""
        for cell in row:
            printLine += str(cell)
        print(printLine)

# Center-value Distance = 
# map [y] [x]
def direct_search():
    MAX_X = len(ROOM_MAP)
    MAX_Y = len(ROOM_MAP[0])

    def callbackFunc(x):
        print(f"{x[0]},{x[1]}")
        POINTS.append(x)
        

    bounds = op.Bounds([0, 0], [MAX_X-1, MAX_Y-1])
    results = op.direct( obj_f, bounds, maxiter=10000, maxfun=10000, vol_tol=TERMINATE_FLOAT, callback=callbackFunc )
    print(f'start coord: {FIRST_COORD}')
    print(f'final coord: {results.x}')
    print(f'optimal power: {results.fun}')
    print(f'iter: {results.nfev}')
    print(results.message)


def obj_f(t_coord):
    global FIRST_COORD
    if FIRST_COORD is None:
        FIRST_COORD = t_coord
    f_val = 0
    for receiver in R_COORD_LIST:
        f_val += TRANSMIT_POWER - signal_sim( (int(t_coord[0]), int(t_coord[1])), receiver, TRANSMIT_POWER, ROOM_MAP)
    f_val /= len(R_COORD_LIST)
    return f_val


def main_single():
    global ROOM_MAP
    ROOM_MAP = toMapArray()
    getReceivers()
    direct_search()
    print(obj_f( FIRST_COORD ))

def main_two():
    global ROOM_MAP
    ROOM_MAP = scatterMap
    getReceivers()
    print("======================= Scatter =======================")
    print("MAP:")
    printMap()
    print("RESULTS:")
    direct_search()

    ROOM_MAP = paremMap
    getReceivers()
    print("======================= Border =======================")
    print("MAP:")
    printMap()
    print("RESULTS:")
    direct_search()
    

########## PROGRAM START #######################
#main_single()
main_two()
#ROOM_MAP = scatterMap
#printMap()
#ROOM_MAP = paremMap
#printMap()
#direct_search()
#print(type(FIRST_COORD))
#print(obj_f( (5, 5) ))
#print(FIRST_COORD)
#print(obj_f( FIRST_COORD ))
#print(obj_f( ( int(len(ROOM_MAP)/2), int(len(ROOM_MAP[0])/4) ) ))
#print( obj_f( (5, 5) ) )